$(document).ready(function() {
  
  $('.best_in_place').best_in_place();
  
  var arrayBIP = $('span.best_in_place');
  for(var i = 0; i < arrayBIP.length; i++)
  {
  	$('#'+arrayBIP[i].id).attr('title', 'Click to edit');
  }
  
  $('.edit_experience').each(function()
  {
    handleAjaxEdition($(this).attr("id"));
  });
  $('.edit_education').each(function()
  {
	handleAjaxEdition($(this).attr("id"));
  });
  
});

/* Add */

function displayNewForm(model) {
  $.ajax({
  	url: "../"+model+"s/new",
  	success: function(data){
  	  $('#new_'+model).html(data);
  	  $('#new_'+model).show();
  	  $('#link_add_'+model).hide();
  	  handleAjaxCreation(model);
  	}
  })   
}

function hideNewForm(model) {
  $('#new_'+model).hide();
  $('#link_add_'+model).show();
}

function handleAjaxCreation(model) {
  $('#new_'+model)
    .bind("ajax:success",function(evt, data, status, xhr)
    {
      $.ajax({
  	  url:  "showblock",
  	  type: "POST",
  	  data: {model: model},
  	  success: function(data){
	    $('#'+model+'s').html(data);
	      $('.edit_'+model).each(function()
	      {
	        handleAjaxEdition($(this).attr("id"));
	      });
  	  }
  	  }) 
  	})
  	.bind("ajax:error", function(evt, xhr, status)
  	{
  	  try {
  	    errors = $.parseJSON(xhr.responseText);
  	  }
  	  catch(err) {
  	    errors = {message: "JSON Error"};
  	  }
  	  errorText = "Error(s): ";
  	  for(error in errors) {
  	    errorText += error+" "+errors[error]+" ";
  	  }
  	  $('#errors_new_'+model).html(errorText);
  	})
  	;	
}

/* Edit */

function displayEditForm(model, id) {
  $('#edit_'+model+'_'+id).show();
  $('#show_'+model+'_'+id).hide();
}

function hideEditForm(model, id) {
  $('#edit_'+model+'_'+id).hide();
  $('#show_'+model+'_'+id).show();  
}

function handleAjaxEdition(form_id) {
  arrayId = form_id.split('_'); 
  var model = arrayId[1];
  var id = arrayId[2];  
  $('#'+"show_"+model+"_"+id).click(function()
  {
    displayEditForm(model,id);
  });
  $('#'+form_id)
    .bind("ajax:success",function(evt, data, status, xhr)
    {
      if(xhr.responseText == "Delete ok") {
      	$('#'+model+'_'+id).remove();
      }
      else {
      	$.ajax({
  	    url:  "showpart",
  	    type: "POST",
  	    data: {model: model, id: id},
  	    success: function(data){
  	  	  $('#'+model+'_'+id).html(data);
  	 	  handleAjaxEdition(form_id);
  	    }
  	    })
      }      
  	 })
  	 .bind("ajax:error", function(evt, xhr, status)
  	 {
  	   try {
  	     errors = $.parseJSON(xhr.responseText);
  	   }
  	   catch(err) {
  	 	   errors = {message: "JSON Error"};
  	   }
  	   errorText = "Error(s): ";
  	   for(error in errors) {
  	 	   errorText += error+" "+errors[error]+" ";
  	   }
  	   $('#errors'+id).html(errorText);
  	 })
  	;	
}