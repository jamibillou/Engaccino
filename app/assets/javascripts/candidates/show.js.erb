$(document).ready(function() {
  
  $('.best_in_place').best_in_place();
  
  $('span.best_in_place').each(function()      { $(this).attr('title', 'Click to edit'); });
  
  $('.edit_experience').each(function()        { handleAjaxEdition($(this).attr("id")); });
  
  $('.edit_education').each(function()         { handleAjaxEdition($(this).attr("id")); });
  
  $('.edit_professionalSkill').each(function() { handleAjaxEdition($(this).attr("id")); });
  
  $('#edit_image').click(function()            { $('#image_button').click(); });
  
  $('#image_button').change(function()         { $('#image_form').submit(); });
});

/* OBJECT CREATION */

function handleAjaxCreation(model) {
$('#new_'+model)
  .bind("ajax:success", function(evt, data, status, xhr) { callRefresh(model, data); })
	.bind("ajax:error",   function(evt, xhr, status)       { $('#errors_new_'+model).html(buildErrorMessages(xhr)); });
}

function displayNewForm(model) {
  $.ajax({
  	url: "../"+model+"s/new",
  	success: function(data){
  	  $('#new_'+model).html(data);
  	  $('#new_'+model).show();
  	  $('#link_add_'+model).hide();
  	  handleAjaxCreation(model);
  	}
  })   
}

function hideNewForm(model) {
  $('#new_'+model).hide();
  $('#link_add_'+model).show();
}


/* OBJECT EDITION */

function handleAjaxEdition(form_id) {
  arrayId = form_id.split('_'); 
  var model = arrayId[1];
  var id = arrayId[2];
  $('#'+"show_"+model+"_"+id).click(function() { displayEditForm(model, id); });
  $('#'+form_id)
    .bind("ajax:success",function(evt, data, status, xhr)
    {
      if(xhr.responseText == "Delete ok") {
      	$('#'+model+'_'+id).remove();
      }
      else {
      	callRefresh(model, data);
      }      
	 })
	 .bind("ajax:error", function(evt, xhr, status) { $('#errors'+id).html(buildErrorMessages(xhr)); });	
}

function displayEditForm(model, id) {
  $('#edit_'+model+'_'+id).show();
  $('#show_'+model+'_'+id).hide();
}

function hideEditForm(model, id) {
  $('#edit_'+model+'_'+id).hide();
  $('#show_'+model+'_'+id).show();  
}

function buildErrorMessages(xhr) {
  try { errors = $.parseJSON(xhr.responseText); }
  catch(err) { errors = { message: "JSON Error" }; }
  errorMessages = "Error(s): ";
  for(error in errors) { errorMessages += error+" "+errors[error]+" "; }
  return errorMessages;
}

function callRefresh(model, data) {
  $.ajax({
    url:  "refresh",
    type: "POST",
    data: {model: model},
    success: function(data) {
      $('#'+model+'s').html(data);
      $('.edit_'+model).each(function() { handleAjaxEdition($(this).attr("id")); });
  	}
  })
}